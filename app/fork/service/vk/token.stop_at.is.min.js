'use strict';

//process.chdir(process.cwd());

var azbn = require('./../../../../azbnode/LoadAzbnode')({
		root_module : module,
		mdls :{
			include : {
				mysql : true,
				vk : true,
				//tg : true,
				//webclient : true,
				//https : true,
			},
		},
	});

var data = azbn.mdl('fork').parseCliData(process.argv);


var createNotifyEmail = function(uid, msg) {

	azbn.mdl('mysql').query("" +
		"SELECT " +
			"* " +
		"FROM " +
			"`" + azbn.mdl('cfg').mysql.t.email.queue + "` " +
		"WHERE " +
			"uid = '" + uid + "' " +
		"ORDER BY " +
			"id" +
		"", function(_err, rows, fields) {

			if (_err) {

				azbn.mdl('winston').warn('Error on search emails in queue: ' + _err);

			} else if(rows.length == 0) {

				var item = {
					created_at : azbn.now_sec(),
					sended_at : 0,
					status : 0,
					uid : uid,
					email : msg.email,
					subject : msg.subject,
					tpl : msg.tpl,
					p : JSON.stringify(msg),
				};

				azbn.mdl('mysql').query("INSERT INTO `" + azbn.mdl('cfg').mysql.t.email.queue + "` SET ? ", item, function(__err, __result) {

					if(__err) {

						azbn.mdl('winston').error(__err);

					}

				});

			} else {



		}

	});

};


azbn.mdl('mysql').connect(function(err){

	var _now = azbn.now_sec();
	var _moment__border__week = _now + (7 * 24 * 60 * 60);

	if(err) {

		azbn.mdl('winston').warn('Could not connect to mysql: ' + err);

	} else {

		azbn.mdl('vk').loadApps();

		azbn.mdl('mysql').query("" +
			"SELECT " +
				"`" + azbn.mdl('cfg').mysql.t.profile + "`.id as profile_id, " +
				"`" + azbn.mdl('cfg').mysql.t.profile + "`.email as profile_email, " +
				"`" + azbn.mdl('cfg').mysql.t.vk.token + "`.* " +
			"FROM " +
				"`" + azbn.mdl('cfg').mysql.t.profile + "`, " +
				"`" + azbn.mdl('cfg').mysql.t.vk.token + "` " +
			"WHERE " +
				"`" + azbn.mdl('cfg').mysql.t.vk.token + "`.stop_at < '" + _moment__border__week + "' " +
				"AND " +
				"`" + azbn.mdl('cfg').mysql.t.vk.token + "`.profile = `" + azbn.mdl('cfg').mysql.t.profile + "`.id " +
			"ORDER BY " +
				"`" + azbn.mdl('cfg').mysql.t.vk.token + "`.id" +
			"", function(_err, rows, fields) {

			if (_err) {

				azbn.mdl('winston').warn('Error on load VK tokens: ' + _err);

			} else if(rows.length == 0) {

				//azbn.mdl('winston').info('No forks in DB!');

			} else {

				for(var i = 0; i < rows.length; i++) {

					(function(item){

						//__apps[item.id] = item;

						if(item.stop_at < _now) {

							// uid = service.vk.token.0.stopped
							azbn.echo('Stopped! ' + item.user_id);
							createNotifyEmail('service.vk.token.' + item.profile + '.' + item.id + '.stopped', {
								email : item.profile_email,
								subject : 'Окончен оплаченный период работы аккаунта',
								tpl : __dirname,
							});

						} else if(item.stop_at < (_now + 2 * 24 * 60 * 60)) {

							// uid = service.vk.token.0.veryhot
							azbn.echo('Very hot period! ' + item.user_id);
							createNotifyEmail('service.vk.token.' + item.profile + '.' + item.id + '.veryhot', {
								email : item.profile_email,
								subject : 'Всего 2 дня до окончания оплаченного периода',
								tpl : __dirname,
							});

						} else {

							// uid = service.vk.token.0.hot
							azbn.echo('Hot period! ' + item.user_id);
							createNotifyEmail('service.vk.token.' + item.profile + '.' + item.id + '.hot', {
								email : item.profile_email,
								subject : 'Менее недели до окончания оплаченного периода',
								tpl : __dirname,
							});

						}

						//azbn.echo(item.app_id + '.' + item.user_id);

						//azbn.echo(azbn.mdl('vk').account(item));

					})(rows[i]);

				}

			}

		});

	}
});

process.on('exit', function() {
	//azbn.mdl('winston').warn(__filename + ' is stoped');
});

/*
process.on('message', function(msg) {
	console.log(msg);
});
*/